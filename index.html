<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitch PiP Viewer with Chat (PWA)</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      margin: 0;
      background: black;
      height: 100vh;
      overflow: hidden;
      display: flex;
      color: white;
    }
    .video-area {
      position: relative;
      flex: 3;
    }
    .main-player, .pip-player {
      position: absolute;
      border: none;
    }
    .main-player {
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .pip-player {
      width: 30%;
      height: 30%;
      bottom: 10px;
      right: 10px;
      border: 2px solid #fff;
      box-shadow: 0 0 10px #000;
      z-index: 2;
    }
    .chat-area {
      flex: 1;
      border-left: 1px solid #444;
    }
    iframe.chat {
      width: 100%;
      height: 100%;
      border: none;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 3;
      background: rgba(0,0,0,0.5);
      padding: 5px;
      border-radius: 5px;
    }
    .controls input {
      padding: 5px;
      width: 150px;
      margin-right: 5px;
    }
    .controls button {
      padding: 5px 10px;
      background: #9146FF;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }
    #install-guide {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      text-align: center;
      z-index: 1000;
    }
    #install-guide button {
      margin-top: 15px;
      padding: 8px 15px;
      background: #9146FF;
      color: white;
      border: none;
    }
    #install-guide img {
      max-width: 250px;
      margin-top: 10px;
      border: 1px solid #fff;
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }

    function getChannelName(input) {
      try {
        if (input.includes('twitch.tv/')) {
          const url = new URL(input);
          return url.pathname.replace('/', '').trim();
        }
      } catch (e) {}
      return input.trim();
    }

    let ch1 = localStorage.getItem('channel1') || "monstercat"; // 主畫面
    let ch2 = localStorage.getItem('channel2') || "lofi_girl";  // 小畫面

    function loadPlayers() {
      const parent = location.hostname;
      document.getElementById("main").src =
        `https://player.twitch.tv/?channel=${ch1}&parent=${parent}`;
      document.getElementById("pip").src =
        `https://player.twitch.tv/?channel=${ch2}&parent=${parent}`;
      document.getElementById("chat").src =
        `https://www.twitch.tv/embed/${ch1}/chat?parent=${parent}`;
      document.getElementById("ch1").value = ch1;
      document.getElementById("ch2").value = ch2;
    }

    function swapPlayers() {
      [ch1, ch2] = [ch2, ch1];
      saveChannels();
      loadPlayers();
    }

    function updateChannels() {
      ch1 = getChannelName(document.getElementById('ch1').value);
      ch2 = getChannelName(document.getElementById('ch2').value);
      saveChannels();
      loadPlayers();
    }

    function saveChannels() {
      localStorage.setItem('channel1', ch1);
      localStorage.setItem('channel2', ch2);
    }

    function showInstallGuide() {
      document.getElementById('install-guide').style.display = 'flex';
    }

    function hideInstallGuide() {
      document.getElementById('install-guide').style.display = 'none';
    }

    window.onload = function() {
      loadPlayers();
      // 自動偵測 iOS Safari，第一次進入顯示提示
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isInStandalone = window.matchMedia('(display-mode: standalone)').matches;
      if (isIOS && !isInStandalone && !localStorage.getItem('installPromptShown')) {
        showInstallGuide();
        localStorage.setItem('installPromptShown', '1');
      }
    }
  </script>
</head>
<body>
  <div class="video-area">
    <iframe id="main" class="main-player" allowfullscreen></iframe>
    <iframe id="pip" class="pip-player" allowfullscreen></iframe>
    <div class="controls">
      <input id="ch1" placeholder="主畫面頻道" />
      <input id="ch2" placeholder="小畫面頻道" />
      <button onclick="updateChannels()">載入</button>
      <button onclick="swapPlayers()">切換主畫面</button>
      <button onclick="showInstallGuide()">安裝</button>
    </div>
  </div>
  <div class="chat-area">
    <iframe id="chat" class="chat"></iframe>
  </div>

  <!-- 安裝提示 -->
  <div id="install-guide">
    <h2>安裝到主畫面</h2>
    <p>1. 點選 Safari 的 <strong>分享</strong> 按鈕。</p>
    <p>2. 往下滑並選擇 <strong>加入主畫面</strong>。</p>
    <p>3. 點 <strong>加入</strong> 完成安裝。</p>
    <img src="https://i.imgur.com/dvKz7pZ.png" alt="安裝教學">
    <button onclick="hideInstallGuide()">關閉</button>
  </div>
</body>
</html>
